# 压力测试笔记（tcpkali 与 iperf3）

## 适用场景对比
- tcpkali：面向高并发 TCP 长连接与应用层吞吐/延迟压测，适合当前 8888 端口的 Echo 服务。
- iperf3：面向链路带宽基准（TCP/UDP），用于测网络栈/带宽上限，不含应用层逻辑。

## tcpkali

### 安装（Ubuntu/Debian）
```bash
sudo apt-get update
sudo apt-get install -y tcpkali
```

### 基本压测示例（Echo 服务 8888）
```bash
# 1000 并发连接，发送 "ping\n"，持续 30s
tcpkali -c 1000 -m "ping\n" -T 30s 127.0.0.1:8888
```

### 常用参数
- `-c N`：并发连接数。
- `-m "MSG"`：发送的消息模板（可换成业务协议报文）。
- `-T 30s`：持续时间。
- `-r CPS` / `-R CPS`：设置每秒发送速率或连接速率。
- `--think-time 5ms`：两次发送间隔，模拟真实客户端。
- `--connections-high-wat 2000`：连接上限。

### 观察输出
- `TX kB/s` / `RX kB/s`：发送/接收吞吐。
- `Latency` 统计：P50/P95/P99 延迟。
- `connected clients`：存活连接数。

### 示例：逐步加压
```bash
# 200 并发，发送 64 字节消息
tcpkali -c 200 -m "0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef\n" -T 20s 127.0.0.1:8888

# 1000 并发，限制发送速率 50k req/s，避免压满单机网络
tcpkali -c 1000 -m "ping\n" -R 50000 -T 30s 127.0.0.1:8888
```

## iperf3

### 安装（Ubuntu/Debian）
```bash
sudo apt-get update
sudo apt-get install -y iperf3
```

### 基本用法
```bash
# 服务器（监听默认 5201）
iperf3 -s

# 客户端（4 并行流，10 秒）
iperf3 -c 127.0.0.1 -P 4 -t 10
```

### 常用参数
- `-P N`：并行流数量（提高带宽利用）。
- `-t N`：测试时长。
- `-u`：UDP 模式（带宽/丢包测试）。
- `-b 200M`：UDP 指定带宽。

### 观察输出
- `sender/receiver` 带宽（Mbits/sec）。
- `Retr`（TCP 重传）或 UDP 的丢包率、抖动。

## 建议的测试步骤（针对本项目）
1) **基准带宽**：用 `iperf3` 测本机/局域网带宽上限，心中有谱。
2) **应用压测**：用 `tcpkali` 对 8888 端口逐步提高并发和速率，观察 Echo 响应、延迟与吞吐。
3) **监控观察**：同时关注 CPU、内存、`sar -n DEV` 或 `ss -s`，确认瓶颈位置。
4) **调参重测**：调整线程数、消息大小、连接数，记录拐点与 P99 延迟。

## 参考命令速查
```bash
# tcpkali 基线
tcpkali -c 200 -m "ping\n" -T 20s 127.0.0.1:8888

# tcpkali 高并发 + 限速
tcpkali -c 1000 -m "ping\n" -R 50000 -T 30s 127.0.0.1:8888

# iperf3 TCP 带宽
iperf3 -s                # 服务端
iperf3 -c 127.0.0.1 -P 4 -t 10

# iperf3 UDP 带宽/丢包
iperf3 -s
iperf3 -u -c 127.0.0.1 -b 200M -t 10
```
